<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Resume Toast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-slate-800 shadow-lg border-b border-slate-700">
            <div class="max-w-7xl mx-auto px-4 py-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-white">Admin Dashboard</h1>
                        <p class="text-slate-400 text-sm mt-1">Resume Toast Analytics</p>
                    </div>
                    <div id="authSection">
                        <button id="loginBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                            Admin Sign In
                        </button>
                        <div id="userInfo" class="hidden">
                            <span id="userEmail" class="text-slate-300 text-sm mr-4"></span>
                            <button id="logoutBtn" class="text-red-400 hover:text-red-300">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-8">
            <!-- Access Denied -->
            <div id="accessDenied" class="hidden text-center py-12">
                <div class="bg-red-900/20 border border-red-500 rounded-lg p-8 max-w-md mx-auto">
                    <h2 class="text-2xl font-bold text-red-400 mb-4">üö´ Access Denied</h2>
                    <p class="text-slate-300">This dashboard is only accessible to admin users.</p>
                    <p class="text-slate-400 text-sm mt-2">Authorized email: {{ admin_email }}</p>
                </div>
            </div>

            <!-- Login Prompt -->
            <div id="loginPrompt" class="text-center py-12">
                <div class="bg-slate-800 rounded-lg shadow-xl p-8 border border-slate-700 max-w-md mx-auto">
                    <h2 class="text-2xl font-bold mb-4">Admin Access Required</h2>
                    <p class="text-slate-400 mb-6">Sign in with your admin account to view the dashboard.</p>
                    <button onclick="document.getElementById('loginBtn').click()" 
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                        Sign In
                    </button>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="hidden">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-400 text-sm">Total Reviews</p>
                                <p id="totalReviews" class="text-3xl font-bold text-white mt-1">-</p>
                            </div>
                            <div class="text-4xl">üìÑ</div>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-400 text-sm">Total Users</p>
                                <p id="totalUsers" class="text-3xl font-bold text-white mt-1">-</p>
                            </div>
                            <div class="text-4xl">üë•</div>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-400 text-sm">Average Score</p>
                                <p id="avgScore" class="text-3xl font-bold text-white mt-1">-</p>
                            </div>
                            <div class="text-4xl">üìä</div>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-400 text-sm">Highest Score</p>
                                <p id="maxScore" class="text-3xl font-bold text-green-400 mt-1">-</p>
                            </div>
                            <div class="text-4xl">üèÜ</div>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-400 text-sm">Lowest Score</p>
                                <p id="minScore" class="text-3xl font-bold text-red-400 mt-1">-</p>
                            </div>
                            <div class="text-4xl">üìâ</div>
                        </div>
                    </div>

                    <div class="bg-slate-800 rounded-lg p-6 border border-slate-700">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-slate-400 text-sm">Last 24 Hours</p>
                                <p id="recent24h" class="text-3xl font-bold text-blue-400 mt-1">-</p>
                            </div>
                            <div class="text-4xl">‚è∞</div>
                        </div>
                    </div>
                </div>

                <!-- Resumes Table -->
                <div class="bg-slate-800 rounded-lg shadow-xl border border-slate-700 overflow-hidden">
                    <div class="p-6 border-b border-slate-700">
                        <h2 class="text-xl font-bold text-white">All Resume Reviews</h2>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-slate-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase">User</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase">Filename</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase">Score</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase">Job Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-slate-300 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="resumesTable" class="divide-y divide-slate-700">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-slate-400">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>

        <!-- Feedback Modal -->
        <div id="feedbackModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-slate-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden border border-slate-700">
                <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                    <h3 class="text-xl font-bold text-white">Resume Feedback</h3>
                    <button onclick="document.getElementById('feedbackModal').classList.add('hidden')" 
                            class="text-slate-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);">
                    <div id="modalContent" class="whitespace-pre-wrap text-slate-200 leading-relaxed"></div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="bg-slate-800 border-t border-slate-700 py-6 mt-12">
            <div class="max-w-7xl mx-auto px-4 text-center">
                <p class="text-slate-400 text-sm">¬© 2024 Mertali Tercan. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "{{ firebase_api_key }}",
            authDomain: "{{ firebase_auth_domain }}",
            projectId: "{{ firebase_project_id }}",
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const provider = new firebase.auth.GoogleAuthProvider();
        const ADMIN_EMAIL = "{{ admin_email }}".toLowerCase();

        let currentUser = null;
        let idToken = null;

        async function loadStats() {
            try {
                const response = await fetch('/api/admin/stats', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });
                
                if (response.status === 403) {
                    showAccessDenied();
                    return;
                }
                
                const data = await response.json();
                
                document.getElementById('totalReviews').textContent = data.total_resumes;
                document.getElementById('totalUsers').textContent = data.total_users;
                document.getElementById('avgScore').textContent = data.average_score;
                document.getElementById('maxScore').textContent = data.highest_score;
                document.getElementById('minScore').textContent = data.lowest_score;
                document.getElementById('recent24h').textContent = data.reviews_last_24h;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadResumes() {
            try {
                const response = await fetch('/api/admin/resumes', {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });
                
                if (response.status === 403) {
                    showAccessDenied();
                    return;
                }
                
                const data = await response.json();
                const tbody = document.getElementById('resumesTable');
                
                if (data.resumes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-slate-400">No resumes yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.resumes.map(resume => {
                    const scoreColor = resume.score >= 80 ? 'text-green-400' : resume.score >= 60 ? 'text-yellow-400' : 'text-red-400';
                    const date = new Date(resume.created_at).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    return `
                        <tr class="hover:bg-slate-700/50">
                            <td class="px-6 py-4 text-sm text-slate-300">${resume.user_email}</td>
                            <td class="px-6 py-4 text-sm text-slate-300">${resume.filename}</td>
                            <td class="px-6 py-4 text-sm font-bold ${scoreColor}">${resume.score}</td>
                            <td class="px-6 py-4 text-sm text-slate-400">${resume.job_role}</td>
                            <td class="px-6 py-4 text-sm text-slate-400">${date}</td>
                            <td class="px-6 py-4 text-sm">
                                <button onclick="viewFeedback('${resume._id}', \`${resume.feedback.replace(/`/g, '\\`')}\`)" 
                                        class="text-blue-400 hover:text-blue-300 mr-3">View</button>
                                <button onclick="downloadResume('${resume._id}')" 
                                        class="text-green-400 hover:text-green-300">Download</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading resumes:', error);
            }
        }

        function viewFeedback(resumeId, feedback) {
            document.getElementById('modalContent').textContent = feedback;
            document.getElementById('feedbackModal').classList.remove('hidden');
        }

        async function downloadResume(resumeId) {
            try {
                const response = await fetch(`/api/admin/download/${resumeId}`, {
                    headers: { 'Authorization': `Bearer ${idToken}` }
                });
                const data = await response.json();
                window.open(data.download_url, '_blank');
            } catch (error) {
                alert('Error downloading resume: ' + error.message);
            }
        }

        function showAccessDenied() {
            document.getElementById('loginPrompt').classList.add('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('accessDenied').classList.remove('hidden');
        }

        // Auth
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                idToken = await user.getIdToken();
                
                // Check if admin
                if (user.email.toLowerCase() !== ADMIN_EMAIL) {
                    showAccessDenied();
                    return;
                }
                
                // Show dashboard
                document.getElementById('loginPrompt').classList.add('hidden');
                document.getElementById('accessDenied').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('loginBtn').classList.add('hidden');
                document.getElementById('userInfo').classList.remove('hidden');
                document.getElementById('userEmail').textContent = user.email;
                
                // Load data
                loadStats();
                loadResumes();
            } else {
                document.getElementById('loginPrompt').classList.remove('hidden');
                document.getElementById('dashboardContent').classList.add('hidden');
                document.getElementById('accessDenied').classList.add('hidden');
                document.getElementById('loginBtn').classList.remove('hidden');
                document.getElementById('userInfo').classList.add('hidden');
            }
        });

        document.getElementById('loginBtn').addEventListener('click', async () => {
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await auth.signOut();
        });
    </script>
</body>
</html>